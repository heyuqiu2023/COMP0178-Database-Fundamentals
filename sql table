CREATE TABLE  Users (
    user_id INT AUTO_INCREMENT PRIMARY KEY,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(100) NOT NULL,
    username VARCHAR(100) NOT NULL,
    role ENUM('buyer', 'seller') NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE Category (
    category_id INT AUTO_INCREMENT PRIMARY KEY,
    category_name VARCHAR(100) UNIQUE NOT NULL,
    description TEXT
);


CREATE TABLE Auction (
    auction_id INT AUTO_INCREMENT PRIMARY KEY,
    seller_id INT NOT NULL,
    category_id INT NOT NULL,
    title VARCHAR(100) NOT NULL,
    description TEXT,
    starting_price DECIMAL(10,2) NOT NULL,
    reserve_price DECIMAL(10,2) DEFAULT 0.00,
    start_time DATETIME NOT NULL,
    end_time DATETIME NOT NULL,
    status ENUM('waiting', 'active', 'ended', 'cancelled') DEFAULT 'waiting',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (seller_id) REFERENCES Users(user_id)
        ON DELETE CASCADE,
    FOREIGN KEY (category_id) REFERENCES Category(category_id)
        ON DELETE CASCADE
);

CREATE TABLE Bid (
    bid_id INT AUTO_INCREMENT PRIMARY KEY,
    auction_id INT NOT NULL,
    bidder_id INT NOT NULL,
    bid_amount DECIMAL(10,2) NOT NULL,
    bid_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE,

    FOREIGN KEY (auction_id) REFERENCES Auction(auction_id)
        ON DELETE CASCADE,
    FOREIGN KEY (bidder_id) REFERENCES Users(user_id)
        ON DELETE CASCADE
);

CREATE TABLE Watchlist (
    watchlist_id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    auction_id INT NOT NULL,
    email_notifications BOOLEAN DEFAULT TRUE,
    added_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES Users(user_id)
        ON DELETE CASCADE,
    FOREIGN KEY (auction_id) REFERENCES Auction(auction_id)
        ON DELETE CASCADE,

    UNIQUE (user_id, auction_id)   -- 防止重复关注
);

CREATE TABLE Notification (
    notification_id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    auction_id INT NOT NULL,
    bid_id INT NULL,
    type ENUM('new_bid', 'outbid', 'auction_ended', 'reserve_not_met') NOT NULL,
    sent_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    is_read BOOLEAN DEFAULT FALSE,
    email_sent BOOLEAN DEFAULT FALSE,

    FOREIGN KEY (user_id) REFERENCES Users(user_id)
        ON DELETE CASCADE,
    FOREIGN KEY (auction_id) REFERENCES Auction(auction_id)
        ON DELETE CASCADE,
    FOREIGN KEY (bid_id) REFERENCES Bid(bid_id)
        ON DELETE SET NULL
);

CREATE TABLE AuctionOutcome (
    outcome_id INT AUTO_INCREMENT PRIMARY KEY,

    auction_id INT NOT NULL UNIQUE,
    winner_id INT NULL,

    final_price DECIMAL(10, 2) NULL,
    reserve_met BOOLEAN DEFAULT FALSE,
    seller_accepted BOOLEAN DEFAULT FALSE,
    acceptance_deadline DATETIME NOT NULL,
    
    concluded_at DATETIME NOT NULL,

    seller_notified BOOLEAN DEFAULT FALSE,
    winner_notified BOOLEAN DEFAULT FALSE,

    FOREIGN KEY (auction_id) REFERENCES Auction(auction_id)
        ON DELETE CASCADE,

    FOREIGN KEY (winner_id) REFERENCES Users(user_id)
        ON DELETE SET NULL

);

CREATE TABLE Recommendation (
    rec_id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    auction_id INT NOT NULL,
    reason VARCHAR(200) NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES Users(user_id)
        ON DELETE CASCADE,

    FOREIGN KEY (auction_id) REFERENCES Auction(auction_id)
        ON DELETE CASCADE
);

CREATE TABLE UserActivity (
    activity_id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    auction_id INT NULL,
    action ENUM('view', 'bid', 'watch', 'search', 'login') NOT NULL,
    action_time DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES Users(user_id)
        ON DELETE CASCADE,

    FOREIGN KEY (auction_id) REFERENCES Auction(auction_id)
        ON DELETE SET NULL
);
